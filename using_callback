import pyaudio
import speech_recognition as sr
import numpy as np

# Initialize PyAudio and SpeechRecognition
audio = pyaudio.PyAudio()
recognizer = sr.Recognizer()

# Parameters
FORMAT = pyaudio.paInt16
CHANNELS = 1
RATE = 44100
CHUNK = 1024
DEVICE_INDEX = 4  # Replace with your device index


# Callback function to process audio data
def callback(in_data, frame_count, time_info, status):
    # Convert audio data to NumPy array
    audio_data = np.frombuffer(in_data, dtype=np.int16)

    # Create an AudioData instance
    audio = sr.AudioData(in_data, RATE, 2)

    # Try to recognize the speech in the audio data
    try:
        text = recognizer.recognize_google(audio)
        print(f"Transcription: {text}")
    except sr.UnknownValueError:
        print("Sorry, I could not understand the audio.")
    except sr.RequestError as e:
        print(f"Could not request results; {e}")

    return (in_data, pyaudio.paContinue)


# Open the audio stream
stream = audio.open(
    format=FORMAT,
    channels=CHANNELS,
    rate=RATE,
    input=True,
    input_device_index=DEVICE_INDEX,
    frames_per_buffer=CHUNK,
    stream_callback=callback,
)

# Start the stream
stream.start_stream()

print("Listening...")

# Keep the script running
try:
    while stream.is_active():
        pass
except KeyboardInterrupt:
    pass

# Stop and close the stream
stream.stop_stream()
stream.close()
audio.terminate()
